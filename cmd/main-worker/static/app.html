<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DeltaDatabase â€” Management</title>
  <link rel="stylesheet" href="/css/delta.css" />
</head>
<body>
  <div id="overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-logo">
        <div class="sidebar-logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 7v10c0 2 1.5 3 3.5 3h9c2 0 3.5-1 3.5-3V7c0-2-1.5-3-3.5-3h-9C5.5 4 4 5 4 7z"/>
            <path d="M4 7c0 2 1.5 3 3.5 3h9C18.5 10 20 9 20 7"/>
            <path d="M4 12c0 2 1.5 3 3.5 3h9c2 0 3.5-1 3.5-3"/>
          </svg>
        </div>
        <div>
          <div class="sidebar-brand">DeltaDatabase</div>
          <div class="sidebar-status">
            <span class="status-dot" id="statusDot"></span>
            <span class="status-text" id="statusText">Checkingâ€¦</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav" id="sidebarNav">
        <button class="nav-item active" data-page="dashboard" onclick="navigate('dashboard')">
          <span class="nav-icon">ğŸ </span><span>Dashboard</span>
        </button>
        <button class="nav-item" data-page="databases" onclick="navigate('databases')">
          <span class="nav-icon">ğŸ—„ï¸</span><span>Databases</span>
        </button>
        <button class="nav-item" data-page="entities" onclick="navigate('entities')">
          <span class="nav-icon">ğŸ“¦</span><span>Entities</span>
        </button>
        <button class="nav-item" data-page="workers" onclick="navigate('workers')">
          <span class="nav-icon">âš™ï¸</span><span>Workers</span>
        </button>
        <button class="nav-item" data-page="schemas" onclick="navigate('schemas')">
          <span class="nav-icon">ğŸ“‹</span><span>Schemas</span>
        </button>
        <button class="nav-item" data-page="apikeys" onclick="navigate('apikeys')">
          <span class="nav-icon">ğŸ”‘</span><span>API Keys</span>
        </button>
        <button class="nav-item" data-page="explorer" onclick="navigate('explorer')">
          <span class="nav-icon">ğŸ”</span><span>Explorer</span>
        </button>
      </nav>

      <div class="sidebar-user">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">?</div>
          <div>
            <div class="user-name" id="userName">Loadingâ€¦</div>
            <div class="user-role" id="userRole">Member</div>
          </div>
        </div>
        <button class="btn btn-ghost btn-sm btn-block" onclick="logout()" style="gap:.375rem">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          Sign Out
        </button>
      </div>
    </aside>

    <!-- Main content -->
    <div class="app-main">
      <!-- Top bar -->
      <header class="topbar">
        <button class="btn-icon" onclick="toggleSidebar()" style="display:none" id="menuBtn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <span class="topbar-title" id="pageTitle">Dashboard</span>
        <div class="topbar-right">
          <span class="badge hide-mobile" id="userBadge" style="display:none"></span>
          <button class="btn-icon" onclick="refreshAll()" title="Refresh">
            <svg id="refreshIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/>
              <path d="M20.49 9A9 9 0 005.64 5.64L1 10M23 14l-4.64 4.36A9 9 0 013.51 15"/>
            </svg>
          </button>
        </div>
      </header>

      <!-- Pages -->
      <main class="page-content">

        <!-- â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page" id="page-dashboard">
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-header"><span class="stat-icon">ğŸ’š</span><span class="badge badge-green" id="healthBadge">â€”</span></div>
              <div class="stat-value" id="statHealth">â€”</div>
              <div class="stat-label">Health</div>
            </div>
            <div class="stat-card">
              <div class="stat-header"><span class="stat-icon">âš™ï¸</span><span class="badge badge-blue">workers</span></div>
              <div class="stat-value" id="statWorkers">â€”</div>
              <div class="stat-label">Available Workers</div>
            </div>
            <div class="stat-card">
              <div class="stat-header"><span class="stat-icon">ğŸ—„ï¸</span><span class="badge badge-slate">cached</span></div>
              <div class="stat-value" id="statDbs">0</div>
              <div class="stat-label">Databases</div>
            </div>
            <div class="stat-card">
              <div class="stat-header"><span class="stat-icon">ğŸ—ï¸</span><span class="badge badge-yellow">keys</span></div>
              <div class="stat-value" id="statKeys">â€”</div>
              <div class="stat-label">API Keys</div>
            </div>
          </div>

          <div class="two-col">
            <div class="card">
              <div class="card-header"><div class="card-title"><span class="card-title-icon">ğŸ’š</span> System Health</div></div>
              <div id="healthBody" style="font-size:.8rem;color:#94a3b8">Loadingâ€¦</div>
            </div>
            <div class="card">
              <div class="card-header"><div class="card-title"><span class="card-title-icon">ğŸ“Š</span> Cache Statistics</div></div>
              <div id="cacheBody">
                <div class="row-center mb-1">
                  <span style="font-size:.75rem;color:#94a3b8">Entries</span>
                  <span class="spacer"></span>
                  <span style="font-size:.75rem;font-weight:700;color:#38bdf8" id="cacheEntries">â€”</span>
                </div>
                <div class="progress-track mb-2"><div class="progress-fill" id="cacheFill" style="width:0%"></div></div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;text-align:center">
                  <div><div style="font-size:1.25rem;font-weight:700;color:#4ade80" id="cacheHits">â€”</div><div style="font-size:.7rem;color:#475569">Hits</div></div>
                  <div><div style="font-size:1.25rem;font-weight:700;color:#f87171" id="cacheMisses">â€”</div><div style="font-size:.7rem;color:#475569">Misses</div></div>
                  <div><div style="font-size:1.25rem;font-weight:700;color:#facc15" id="cacheEvicts">â€”</div><div style="font-size:.7rem;color:#475569">Evictions</div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- â”€â”€ DATABASES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page hidden" id="page-databases">
          <div class="row mb-3">
            <div class="flex-1">
              <label class="label">Select Database</label>
              <select id="dbDropdown" onchange="onDbDropdownChange()">
                <option value="">â€” choose a database â€”</option>
              </select>
            </div>
            <div>
              <label class="label">&nbsp;</label>
              <button class="btn btn-ghost" onclick="loadDatabases()">â†» Refresh</button>
            </div>
          </div>

          <div id="dbGridWrap" class="db-grid mb-3"></div>

          <div class="card" id="dbEmptyCard" style="display:none">
            <div class="empty-state">
              <div class="empty-icon">ğŸ—„ï¸</div>
              <div class="empty-title">No databases found</div>
              <div class="empty-sub">Write entities to create databases, then refresh.</div>
            </div>
          </div>

          <!-- Create new DB -->
          <div class="card">
            <div class="card-header"><div class="card-title"><span class="card-title-icon">â•</span> Create New Database</div></div>
            <p style="font-size:.8rem;color:#64748b;margin-bottom:.875rem">Databases are created automatically when you write the first entity.</p>
            <div class="grid-2 mb-2">
              <div class="field mb-1">
                <label class="label">Database Name</label>
                <input id="newDbName" type="text" placeholder="e.g. users" />
              </div>
              <div class="field mb-1">
                <label class="label">Entity Key</label>
                <input id="newDbKey" type="text" placeholder="e.g. record_001" />
              </div>
            </div>
            <div class="field mb-2">
              <label class="label">JSON Body</label>
              <textarea id="newDbBody" rows="3" placeholder='{"field": "value"}'></textarea>
            </div>
            <div id="newDbAlert" class="alert hidden mb-2"></div>
            <button class="btn btn-primary" onclick="createNewDb()">Write Entity</button>
          </div>
        </div>

        <!-- â”€â”€ ENTITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page hidden" id="page-entities">
          <div class="two-col">
            <!-- GET -->
            <div class="card">
              <div class="card-header"><div class="card-title"><span class="card-title-icon">ğŸ“¥</span> Get Entity</div></div>
              <div class="field">
                <label class="label">Database</label>
                <select id="getDbSel"></select>
              </div>
              <div class="field">
                <label class="label">Entity Key</label>
                <input id="getKey" type="text" placeholder="e.g. session_001" />
              </div>
              <button class="btn btn-ghost btn-block mb-2" onclick="getEntity()">GET Entity</button>
              <div id="getError" class="alert alert-error hidden mb-2"></div>
              <div id="getResultBox" class="result-box hidden"></div>
            </div>
            <!-- PUT -->
            <div class="card">
              <div class="card-header"><div class="card-title"><span class="card-title-icon">ğŸ“¤</span> Put Entity</div></div>
              <div class="field">
                <label class="label">Database</label>
                <div class="row" style="gap:.375rem">
                  <div style="flex:1">
                    <select id="putDbSel"></select>
                  </div>
                  <div style="flex:1">
                    <input id="putDbCustom" type="text" placeholder="or type newâ€¦" />
                  </div>
                </div>
              </div>
              <div class="field">
                <label class="label">JSON Body <small style="text-transform:none;color:#475569">({"key":{...}})</small></label>
                <textarea id="putBody" rows="6" placeholder='{"my_key": {"field": "value"}}'></textarea>
              </div>
              <div id="putAlert" class="alert hidden mb-2"></div>
              <button class="btn btn-success btn-block" onclick="putEntity()">PUT Entity</button>
            </div>
          </div>
        </div>

        <!-- â”€â”€ WORKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page hidden" id="page-workers">
          <div class="row-center mb-3">
            <span style="font-size:.8rem;color:#94a3b8" id="workerCount">0 workers</span>
            <span class="spacer"></span>
            <button class="btn btn-ghost btn-sm" onclick="loadWorkers()">â†» Refresh</button>
          </div>
          <div id="workersWrap"></div>
          <div class="card hidden" id="workersEmpty">
            <div class="empty-state">
              <div class="empty-icon">âš™ï¸</div>
              <div class="empty-title">No workers registered</div>
              <div class="empty-sub">Start a proc-worker to see it here.</div>
            </div>
          </div>
        </div>

        <!-- â”€â”€ SCHEMAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page hidden" id="page-schemas">
          <div class="grid-panel">
            <!-- List -->
            <div class="card">
              <div class="card-header">
                <div class="card-title" style="justify-content:space-between">
                  <span class="flex-1 card-title"><span class="card-title-icon">ğŸ“‹</span> Schemas</span>
                  <button class="btn btn-xs btn-ghost" onclick="loadSchemas()">â†»</button>
                </div>
              </div>
              <div id="schemaListWrap">
                <div style="font-size:.8rem;color:#64748b;padding:.5rem 0">No schemas yet</div>
              </div>
            </div>
            <!-- Editor -->
            <div class="card">
              <div class="card-header"><div class="card-title"><span class="card-title-icon">âœï¸</span> Edit Schema</div></div>
              <div class="field">
                <label class="label">Schema ID</label>
                <input id="schemaId" type="text" class="mono" placeholder="e.g. user.v1" />
              </div>
              <div class="field">
                <label class="label">JSON Schema (draft-07)</label>
                <textarea id="schemaBody" rows="10" class="mono" style="font-size:.78rem"></textarea>
              </div>
              <div class="row mb-2" style="flex-wrap:wrap;gap:.375rem">
                <button class="btn btn-ghost btn-sm" onclick="loadSchemaById()">Load</button>
                <button class="btn btn-primary btn-sm" onclick="saveSchema()">Save</button>
                <button class="btn btn-sm" style="background:rgba(99,102,241,.2);color:#a5b4fc" onclick="exportPydantic()">ğŸ Pydantic</button>
                <button class="btn btn-sm" style="background:rgba(168,85,247,.2);color:#d8b4fe" onclick="exportTypeScript()">ğŸ”· TypeScript</button>
              </div>
              <div id="schemaAlert" class="alert hidden mb-2"></div>
              <div id="exportWrap" class="hidden">
                <div class="row-center mb-1">
                  <span style="font-size:.75rem;color:#94a3b8">Export</span>
                  <span class="spacer"></span>
                  <button class="btn btn-xs btn-ghost" onclick="copyExport()">Copy</button>
                </div>
                <pre id="exportBox" class="result-box" style="max-height:180px"></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- â”€â”€ API KEYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page hidden" id="page-apikeys">
          <div id="apikeysAdminWarn" class="card hidden" style="margin-bottom:1rem">
            <div class="empty-state">
              <div class="empty-icon">ğŸ”’</div>
              <div class="empty-title">Admin permission required</div>
              <div class="empty-sub">Log in with an admin key to manage API keys.</div>
            </div>
          </div>

          <div id="apikeysContent">
            <!-- Create form -->
            <div class="card mb-3">
              <div class="card-header"><div class="card-title"><span class="card-title-icon">ğŸ”‘</span> Create New Key</div></div>
              <div class="grid-3 mb-2">
                <div class="field mb-1">
                  <label class="label">Name</label>
                  <input id="newKeyName" type="text" placeholder="e.g. ci-deploy" />
                </div>
                <div class="field mb-1">
                  <label class="label">Permissions</label>
                  <div class="perm-group">
                    <label class="perm-check"><input type="checkbox" id="permRead" value="read" checked /><span>read</span></label>
                    <label class="perm-check"><input type="checkbox" id="permWrite" value="write" checked /><span>write</span></label>
                    <label class="perm-check"><input type="checkbox" id="permAdmin" value="admin" /><span>admin</span></label>
                  </div>
                </div>
                <div class="field mb-1">
                  <label class="label">Expires In</label>
                  <input id="newKeyExpiry" type="text" placeholder="24h, 30d (blank=never)" />
                </div>
              </div>
              <div id="newKeyAlert" class="alert hidden mb-2"></div>
              <div id="secretReveal" class="secret-reveal hidden mb-2">
                <div class="secret-reveal-label">âš ï¸ Copy this secret â€” not shown again!</div>
                <code class="secret-value" id="secretValue"></code>
              </div>
              <button class="btn btn-primary" onclick="createAPIKey()">Create Key</button>
            </div>

            <!-- Key list -->
            <div class="card">
              <div class="card-header">
                <div class="card-title" style="justify-content:space-between">
                  <span><span class="card-title-icon">ğŸ“‹</span> Existing Keys</span>
                  <button class="btn btn-xs btn-ghost" onclick="loadAPIKeys()">â†» refresh</button>
                </div>
              </div>
              <div id="keyListWrap">
                <div style="font-size:.8rem;color:#64748b;padding:.5rem 0">No API keys configured</div>
              </div>
            </div>
          </div>
        </div>

        <!-- â”€â”€ EXPLORER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="page hidden" id="page-explorer">
          <div class="card">
            <div class="card-header"><div class="card-title"><span class="card-title-icon">ğŸ”</span> HTTP Explorer</div></div>
            <div class="row mb-2">
              <div style="width:110px">
                <label class="label">Method</label>
                <select id="exMethod">
                  <option>GET</option><option>PUT</option><option>POST</option><option>DELETE</option>
                </select>
              </div>
              <div class="flex-1">
                <label class="label">Path</label>
                <input id="exPath" type="text" class="mono" placeholder="/health" value="/health" />
              </div>
            </div>
            <div class="field mb-2" id="exBodyField" style="display:none">
              <label class="label">Body</label>
              <textarea id="exBody" rows="4" class="mono" placeholder='{"key":"value"}'></textarea>
            </div>
            <div class="row-center mb-3" style="flex-wrap:wrap;gap:.375rem">
              <button class="btn btn-primary" onclick="runExplorer()">Send</button>
              <span style="font-size:.75rem;color:#64748b">Quick:</span>
              <div class="quick-btns">
                <button class="btn btn-ghost btn-xs" onclick="quickReq('GET','/health')">GET /health</button>
                <button class="btn btn-ghost btn-xs" onclick="quickReq('GET','/admin/workers')">GET /admin/workers</button>
                <button class="btn btn-ghost btn-xs" onclick="quickReq('GET','/api/databases')">GET /api/databases</button>
                <button class="btn btn-ghost btn-xs" onclick="quickReq('GET','/api/me')">GET /api/me</button>
                <button class="btn btn-ghost btn-xs" onclick="quickReq('GET','/api/keys')">GET /api/keys</button>
              </div>
            </div>
            <div id="exResult" class="hidden">
              <div class="row-center mb-1">
                <span class="badge" id="exStatus">â€”</span>
                <span style="font-size:.75rem;color:#64748b" id="exLatency"></span>
              </div>
              <pre class="result-box" id="exBody2"></pre>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <script>
  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const STATE = {
    token:    sessionStorage.getItem('delta_token') || '',
    clientId: sessionStorage.getItem('delta_client') || '',
    isAdmin:  false,
    healthy:  false,
    databases:[],
    currentPage: 'dashboard',
  };

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async function boot() {
    if (!STATE.token) { window.location.replace('/'); return; }
    setupMethodListener();
    showMenuBtn();
    await fetchMe();
    await refreshAll();
    navigate('dashboard');
  })();

  function showMenuBtn() {
    if (window.innerWidth < 768) {
      document.getElementById('menuBtn').style.display = '';
    }
  }
  window.addEventListener('resize', () => {
    const btn = document.getElementById('menuBtn');
    if (btn) btn.style.display = window.innerWidth < 768 ? '' : 'none';
  });

  // â”€â”€ API helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function api(path, opts = {}) {
    const headers = { 'Authorization': 'Bearer ' + STATE.token, ...(opts.headers || {}) };
    return fetch(window.location.origin + path, { ...opts, headers });
  }

  // â”€â”€ Me â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchMe() {
    try {
      const r = await api('/api/me');
      if (r.ok) {
        const d = await r.json();
        STATE.clientId = d.client_id;
        STATE.isAdmin  = d.is_admin;
        updateUserUI();
      }
    } catch {}
  }

  function updateUserUI() {
    const initials = (STATE.clientId || '?').slice(0, 2).toUpperCase();
    document.getElementById('userAvatar').textContent = initials;
    document.getElementById('userName').textContent   = STATE.clientId || 'Unknown';
    document.getElementById('userRole').textContent   = STATE.isAdmin ? 'Administrator' : 'Member';
    const badge = document.getElementById('userBadge');
    badge.style.display = '';
    badge.className = 'badge ' + (STATE.isAdmin ? 'badge-blue' : 'badge-slate');
    badge.textContent = STATE.isAdmin ? 'ğŸ‘‘ admin' : 'ğŸ‘¤ ' + (STATE.clientId || '');
  }

  // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function navigate(page) {
    // Update page titles map
    const titles = { dashboard:'Dashboard', databases:'Databases', entities:'Entities',
      workers:'Workers', schemas:'Schemas', apikeys:'API Keys', explorer:'Explorer' };
    // Hide all pages
    document.querySelectorAll('.page').forEach(el => el.classList.add('hidden'));
    document.getElementById('page-' + page).classList.remove('hidden');
    // Update nav items
    document.querySelectorAll('.nav-item').forEach(el => {
      el.classList.toggle('active', el.dataset.page === page);
    });
    document.getElementById('pageTitle').textContent = titles[page] || page;
    STATE.currentPage = page;
    // Close sidebar on mobile
    closeSidebar();
    // Load data for page
    if (page === 'dashboard')  loadDashboard();
    if (page === 'databases')  loadDatabases();
    if (page === 'entities')   { populateDbSelects(); }
    if (page === 'workers')    loadWorkers();
    if (page === 'schemas')    loadSchemas();
    if (page === 'apikeys')    loadAPIKeysPage();
  }

  // â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleSidebar() {
    const sb  = document.getElementById('sidebar');
    const ov  = document.getElementById('overlay');
    const open = sb.classList.toggle('open');
    ov.classList.toggle('open', open);
  }
  function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
  }

  // â”€â”€ Refresh all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function refreshAll() {
    const icon = document.getElementById('refreshIcon');
    icon.classList.add('spin');
    await Promise.all([loadDashboard(), loadDatabases()]);
    icon.classList.remove('spin');
  }

  // â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDashboard() {
    try {
      const r = await api('/health');
      if (r.ok) {
        const h = await r.json();
        STATE.healthy = true;
        document.getElementById('statusDot').className  = 'status-dot ok';
        document.getElementById('statusText').textContent = 'Online';
        document.getElementById('statHealth').textContent  = h.status || 'ok';
        document.getElementById('healthBadge').textContent = 'âœ“ online';
        document.getElementById('statWorkers').textContent = h.available_workers ?? 'â€”';
        document.getElementById('statKeys').textContent    = h.api_keys ?? 'â€”';
        document.getElementById('statDbs').textContent     = STATE.databases.length;

        // Build health table
        const rows = Object.entries(h).map(([k,v]) => {
          const valStr = typeof v === 'boolean' ? (v ? 'âœ“ ok' : 'âœ— fail') : String(v);
          const cls    = v === true || v === 'ok' ? 'badge-green' : typeof v === 'number' ? 'badge-blue' : 'badge-slate';
          return `<div style="display:flex;justify-content:space-between;align-items:center;padding:.375rem 0;border-bottom:1px solid rgba(56,189,248,.06)">
            <span style="font-size:.75rem;color:#94a3b8;font-family:monospace">${esc(k)}</span>
            <span class="badge ${cls}">${esc(valStr)}</span>
          </div>`;
        }).join('');
        document.getElementById('healthBody').innerHTML = rows || '<span style="color:#475569;font-size:.8rem">No data</span>';

        // Cache stats
        const cacheSize = h.entity_cache_size ?? 0;
        const cacheMax  = h.entity_cache_max  ?? 1;
        document.getElementById('cacheEntries').textContent = cacheSize + ' / ' + cacheMax;
        document.getElementById('cacheFill').style.width = Math.min(100, (cacheSize / cacheMax) * 100) + '%';
        document.getElementById('cacheHits').textContent   = h.entity_cache_hits      ?? 0;
        document.getElementById('cacheMisses').textContent = h.entity_cache_misses     ?? 0;
        document.getElementById('cacheEvicts').textContent = h.entity_cache_evictions  ?? 0;
      } else {
        setOffline();
      }
    } catch { setOffline(); }
  }

  function setOffline() {
    STATE.healthy = false;
    document.getElementById('statusDot').className = 'status-dot';
    document.getElementById('statusText').textContent = 'Offline';
    document.getElementById('statHealth').textContent = 'error';
    document.getElementById('healthBadge').className = 'badge badge-red';
    document.getElementById('healthBadge').textContent = 'âœ— offline';
    document.getElementById('healthBody').innerHTML = '<span style="color:#f87171;font-size:.8rem">Server unreachable</span>';
  }

  // â”€â”€ Databases â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDatabases() {
    try {
      const r = await api('/api/databases');
      if (r.ok) {
        STATE.databases = await r.json() || [];
        renderDatabaseGrid();
        populateDbSelects();
        document.getElementById('statDbs').textContent = STATE.databases.length;
      }
    } catch {}
  }

  function renderDatabaseGrid() {
    const wrap = document.getElementById('dbGridWrap');
    const empty = document.getElementById('dbEmptyCard');
    const dropdown = document.getElementById('dbDropdown');

    // Rebuild dropdown
    dropdown.innerHTML = '<option value="">â€” choose a database â€”</option>' +
      STATE.databases.map(db => `<option value="${esc(db)}">${esc(db)}</option>`).join('');

    if (STATE.databases.length === 0) {
      wrap.innerHTML = '';
      empty.style.display = '';
    } else {
      empty.style.display = 'none';
      wrap.innerHTML = STATE.databases.map(db => `
        <button class="db-card" onclick="openDb(${JSON.stringify(db)})">
          <div class="db-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 7v10c0 2 1.5 3 3.5 3h9c2 0 3.5-1 3.5-3V7c0-2-1.5-3-3.5-3h-9C5.5 4 4 5 4 7z"/>
              <path d="M4 7c0 2 1.5 3 3.5 3h9C18.5 10 20 9 20 7"/>
            </svg>
          </div>
          <div>
            <div class="db-card-name">${esc(db)}</div>
            <div class="db-card-sub">Click to explore</div>
          </div>
        </button>`).join('');
    }
  }

  function openDb(db) {
    document.getElementById('getDbSel').value = db;
    document.getElementById('putDbSel').value = db;
    navigate('entities');
  }

  function onDbDropdownChange() {
    const db = document.getElementById('dbDropdown').value;
    if (db) openDb(db);
  }

  function populateDbSelects() {
    const opts = '<option value="">â€” select database â€”</option>' +
      STATE.databases.map(db => `<option value="${esc(db)}">${esc(db)}</option>`).join('');
    document.getElementById('getDbSel').innerHTML = opts;
    document.getElementById('putDbSel').innerHTML = '<option value="">â€” select or type below â€”</option>' +
      STATE.databases.map(db => `<option value="${esc(db)}">${esc(db)}</option>`).join('');
  }

  function createNewDb() {
    const name = document.getElementById('newDbName').value.trim();
    const key  = document.getElementById('newDbKey').value.trim();
    const body = document.getElementById('newDbBody').value.trim() || '{}';
    const alertEl = document.getElementById('newDbAlert');
    if (!name || !key) { showAlert(alertEl, 'error', 'Database name and key are required.'); return; }
    let parsed;
    try { parsed = JSON.parse(body); } catch { showAlert(alertEl, 'error', 'Invalid JSON body.'); return; }
    api('/entity/' + encodeURIComponent(name), {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ [key]: parsed })
    }).then(r => r.json().then(d => {
      if (r.ok) {
        showAlert(alertEl, 'success', `Database "${name}" created with entity "${key}".`);
        loadDatabases();
      } else {
        showAlert(alertEl, 'error', d.error || 'Failed.');
      }
    })).catch(() => showAlert(alertEl, 'error', 'Network error.'));
  }

  // â”€â”€ Entities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function getEntity() {
    const db  = document.getElementById('getDbSel').value;
    const key = document.getElementById('getKey').value.trim();
    const errEl  = document.getElementById('getError');
    const boxEl  = document.getElementById('getResultBox');
    errEl.classList.add('hidden');
    boxEl.classList.add('hidden');
    if (!db || !key) { showAlert(errEl, 'error', 'Database and key are required.'); return; }
    try {
      const r = await api('/entity/' + encodeURIComponent(db) + '?key=' + encodeURIComponent(key));
      if (r.ok) {
        boxEl.textContent = JSON.stringify(await r.json(), null, 2);
        boxEl.classList.remove('hidden');
      } else {
        const d = await r.json().catch(() => ({}));
        showAlert(errEl, 'error', d.error || 'Not found.'); errEl.classList.remove('hidden');
      }
    } catch { showAlert(errEl, 'error', 'Network error.'); errEl.classList.remove('hidden'); }
  }

  async function putEntity() {
    const db  = document.getElementById('putDbCustom').value.trim() || document.getElementById('putDbSel').value;
    const body = document.getElementById('putBody').value.trim();
    const alertEl = document.getElementById('putAlert');
    alertEl.classList.add('hidden');
    if (!db) { showAlert(alertEl, 'error', 'Database is required.'); return; }
    if (!body) { showAlert(alertEl, 'error', 'JSON body is required.'); return; }
    let payload;
    try { payload = JSON.parse(body); } catch { showAlert(alertEl, 'error', 'Invalid JSON.'); return; }
    try {
      const r = await api('/entity/' + encodeURIComponent(db), {
        method: 'PUT', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (r.ok) {
        showAlert(alertEl, 'success', 'Entity written successfully.');
        await loadDatabases();
      } else {
        const d = await r.json().catch(() => ({}));
        showAlert(alertEl, 'error', d.error || 'Failed.');
      }
    } catch { showAlert(alertEl, 'error', 'Network error.'); }
  }

  // â”€â”€ Workers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadWorkers() {
    try {
      const r = await api('/admin/workers');
      if (r.ok) {
        const d = await r.json();
        const workers = Array.isArray(d) ? d : (d.workers || []);
        document.getElementById('workerCount').textContent = workers.length + ' worker(s) registered';
        const wrap = document.getElementById('workersWrap');
        const empty = document.getElementById('workersEmpty');
        if (workers.length === 0) {
          wrap.innerHTML = ''; empty.classList.remove('hidden');
        } else {
          empty.classList.add('hidden');
          wrap.innerHTML = workers.map(w => {
            const avail  = w.status === 'available';
            const tags   = w.tags && Object.keys(w.tags).length > 0 ?
              Object.entries(w.tags).map(([k,v]) => `<span class="badge badge-slate" style="font-family:monospace;font-size:.7rem">${esc(k)}: ${esc(v)}</span>`).join('') : '';
            return `<div class="worker-card">
              <div class="worker-header">
                <div class="worker-id">
                  <div class="worker-id-icon ${avail ? 'available' : 'other'}">${avail ? 'âœ…' : 'âš ï¸'}</div>
                  <div>
                    <div class="worker-meta">${esc(w.worker_id || 'â€”')}</div>
                    <div class="worker-keyid">Key: ${esc(w.key_id || 'â€”')}</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
                  <span class="badge ${avail ? 'badge-green' : 'badge-red'}">${esc(w.status || 'unknown')}</span>
                  ${w.last_seen ? `<span style="font-size:.72rem;color:#475569">${esc(new Date(w.last_seen).toLocaleString())}</span>` : ''}
                </div>
              </div>
              ${tags ? `<div class="worker-tags">${tags}</div>` : ''}
            </div>`;
          }).join('');
        }
      }
    } catch {}
  }

  // â”€â”€ Schemas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadSchemas() {
    try {
      const r = await api('/admin/schemas');
      if (r.ok) {
        const schemas = await r.json() || [];
        const wrap = document.getElementById('schemaListWrap');
        if (schemas.length === 0) {
          wrap.innerHTML = '<div style="font-size:.8rem;color:#64748b;padding:.5rem 0">No schemas yet</div>';
        } else {
          wrap.innerHTML = schemas.map(s => `
            <button class="schema-list-item" onclick="document.getElementById('schemaId').value='${esc(s)}';loadSchemaById()">
              <span>${esc(s)}</span><span style="color:#64748b">edit â†’</span>
            </button>`).join('');
        }
      }
    } catch {}
  }

  async function loadSchemaById() {
    const id = document.getElementById('schemaId').value.trim();
    if (!id) return;
    try {
      const r = await api('/schema/' + encodeURIComponent(id));
      if (r.ok) {
        document.getElementById('schemaBody').value = JSON.stringify(await r.json(), null, 2);
      } else {
        showAlert(document.getElementById('schemaAlert'), 'error', 'Schema not found.');
      }
    } catch {}
  }

  async function saveSchema() {
    const id   = document.getElementById('schemaId').value.trim();
    const body = document.getElementById('schemaBody').value.trim();
    const alertEl = document.getElementById('schemaAlert');
    alertEl.classList.add('hidden');
    if (!id) { showAlert(alertEl, 'error', 'Schema ID required.'); return; }
    let parsed;
    try { parsed = JSON.parse(body); } catch { showAlert(alertEl, 'error', 'Invalid JSON.'); return; }
    try {
      const r = await api('/schema/' + encodeURIComponent(id), {
        method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(parsed)
      });
      if (r.ok) { showAlert(alertEl, 'success', 'Schema saved.'); await loadSchemas(); }
      else {
        const d = await r.json().catch(() => ({}));
        showAlert(alertEl, 'error', d.error || 'Save failed.');
      }
    } catch { showAlert(alertEl, 'error', 'Network error.'); }
  }

  function exportPydantic() {
    const alertEl = document.getElementById('schemaAlert');
    let schema;
    try { schema = JSON.parse(document.getElementById('schemaBody').value); }
    catch { showAlert(alertEl, 'error', 'Invalid JSON schema.'); return; }
    const id   = document.getElementById('schemaId').value;
    const name = id.replace(/[^a-zA-Z0-9]/g,'_') || 'Model';
    const props = schema.properties || {};
    const req   = schema.required || [];
    const lines = ['from pydantic import BaseModel','from typing import Optional, List, Any','','class ' + name + '(BaseModel):'];
    if (!Object.keys(props).length) lines.push('    pass');
    for (const [k,v] of Object.entries(props)) {
      const t = pyType(v);
      lines.push('    ' + k + ': ' + (req.includes(k) ? t : 'Optional['+t+'] = None'));
    }
    setExport(lines.join('\n'));
  }

  function exportTypeScript() {
    const alertEl = document.getElementById('schemaAlert');
    let schema;
    try { schema = JSON.parse(document.getElementById('schemaBody').value); }
    catch { showAlert(alertEl, 'error', 'Invalid JSON schema.'); return; }
    const id = document.getElementById('schemaId').value;
    const name = id.replace(/[^a-zA-Z0-9]/g,'_') || 'Model';
    const props = schema.properties || {};
    const req   = schema.required || [];
    const lines = ['export interface ' + name + ' {'];
    for (const [k,v] of Object.entries(props)) {
      lines.push('  ' + k + (req.includes(k)?'':'?') + ': ' + tsType(v) + ';');
    }
    lines.push('}');
    setExport(lines.join('\n'));
  }

  function setExport(code) {
    document.getElementById('exportBox').textContent = code;
    document.getElementById('exportWrap').classList.remove('hidden');
  }
  function copyExport() {
    navigator.clipboard.writeText(document.getElementById('exportBox').textContent).catch(() => {});
  }

  function pyType(s) {
    if (!s) return 'Any';
    switch (s.type) {
      case 'string': return 'str'; case 'integer': return 'int';
      case 'number': return 'float'; case 'boolean': return 'bool';
      case 'array': return 'List[' + pyType(s.items) + ']';
      case 'object': return 'dict'; default: return 'Any';
    }
  }
  function tsType(s) {
    if (!s) return 'unknown';
    switch (s.type) {
      case 'string': return 'string';
      case 'integer': case 'number': return 'number';
      case 'boolean': return 'boolean';
      case 'array': return tsType(s.items) + '[]';
      case 'object': return 'Record<string, unknown>';
      default: return 'unknown';
    }
  }

  // â”€â”€ API Keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadAPIKeysPage() {
    const warn = document.getElementById('apikeysAdminWarn');
    const content = document.getElementById('apikeysContent');
    if (!STATE.isAdmin) {
      warn.classList.remove('hidden'); content.style.display = 'none';
    } else {
      warn.classList.add('hidden'); content.style.display = '';
      loadAPIKeys();
    }
  }

  async function loadAPIKeys() {
    try {
      const r = await api('/api/keys');
      if (r.ok) {
        const keys = await r.json() || [];
        const wrap = document.getElementById('keyListWrap');
        if (!keys.length) {
          wrap.innerHTML = '<div style="font-size:.8rem;color:#64748b;padding:.5rem 0">No API keys configured</div>';
          return;
        }
        wrap.innerHTML = keys.map(k => {
          const perms = (k.permissions || []).map(p => `<span class="badge badge-blue" style="font-family:monospace">${esc(p)}</span>`).join('');
          return `<div class="key-row">
            <div class="key-info">
              <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.25rem">
                <span class="key-name">${esc(k.name)}</span>
                <span class="badge ${k.enabled !== false ? 'badge-green' : 'badge-red'}">${k.enabled !== false ? 'active' : 'disabled'}</span>
              </div>
              <div class="key-perms">
                ${perms}
                <span style="font-size:.72rem;color:#475569;font-family:monospace">id: ${esc(k.id.slice(0,8))}â€¦</span>
              </div>
            </div>
            <div class="key-meta">${k.expires_at ? 'Exp: ' + new Date(k.expires_at).toLocaleDateString() : 'Never expires'}</div>
            <button class="btn btn-danger btn-xs" onclick="deleteAPIKey('${esc(k.id)}','${esc(k.name)}')">Delete</button>
          </div>`;
        }).join('');
      }
    } catch {}
  }

  async function createAPIKey() {
    const name   = document.getElementById('newKeyName').value.trim();
    const expiry = document.getElementById('newKeyExpiry').value.trim();
    const alertEl = document.getElementById('newKeyAlert');
    const reveal  = document.getElementById('secretReveal');
    alertEl.classList.add('hidden'); reveal.classList.add('hidden');
    if (!name) { showAlert(alertEl, 'error', 'Name is required.'); return; }
    const perms = [];
    if (document.getElementById('permRead').checked)  perms.push('read');
    if (document.getElementById('permWrite').checked) perms.push('write');
    if (document.getElementById('permAdmin').checked) perms.push('admin');
    if (!perms.length) { showAlert(alertEl, 'error', 'At least one permission required.'); return; }
    const body = { name, permissions: perms };
    if (expiry) body.expires_in = expiry;
    try {
      const r = await api('/api/keys', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (r.ok) {
        const d = await r.json();
        document.getElementById('secretValue').textContent = d.secret;
        reveal.classList.remove('hidden');
        showAlert(alertEl, 'success', 'Key "' + d.name + '" created â€” copy the secret!');
        await loadAPIKeys();
      } else {
        const d = await r.json().catch(() => ({}));
        showAlert(alertEl, 'error', d.error || 'Failed.');
      }
    } catch { showAlert(alertEl, 'error', 'Network error.'); }
  }

  async function deleteAPIKey(id, name) {
    if (!confirm('Delete key "' + name + '"?')) return;
    try {
      const r = await api('/api/keys/' + encodeURIComponent(id), { method: 'DELETE' });
      if (r.ok) await loadAPIKeys();
    } catch {}
  }

  // â”€â”€ Explorer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupMethodListener() {
    document.getElementById('exMethod').addEventListener('change', function() {
      const bodyField = document.getElementById('exBodyField');
      bodyField.style.display = (this.value === 'PUT' || this.value === 'POST') ? '' : 'none';
    });
  }

  function quickReq(method, path) {
    document.getElementById('exMethod').value = method;
    document.getElementById('exPath').value   = path;
    document.getElementById('exBodyField').style.display = 'none';
    navigate('explorer');
    setTimeout(runExplorer, 50);
  }

  async function runExplorer() {
    const method = document.getElementById('exMethod').value;
    const path   = document.getElementById('exPath').value;
    const bodyTxt = document.getElementById('exBody').value.trim();
    const start  = Date.now();
    const resultEl = document.getElementById('exResult');
    resultEl.classList.add('hidden');
    const opts = { method };
    if ((method === 'PUT' || method === 'POST') && bodyTxt) {
      opts.headers = { 'Content-Type': 'application/json' };
      opts.body = bodyTxt;
    }
    try {
      const r = await api(path, opts);
      const latency = Date.now() - start;
      const text = await r.text();
      let body;
      try { body = JSON.stringify(JSON.parse(text), null, 2); } catch { body = text; }
      const statusEl = document.getElementById('exStatus');
      statusEl.textContent = r.status;
      statusEl.className = 'badge ' + (r.status >= 200 && r.status < 300 ? 'badge-green' : r.status >= 400 ? 'badge-red' : 'badge-yellow');
      document.getElementById('exLatency').textContent = latency + 'ms';
      document.getElementById('exBody2').textContent = body;
      resultEl.classList.remove('hidden');
    } catch (e) {
      document.getElementById('exStatus').textContent = 'ERR';
      document.getElementById('exStatus').className = 'badge badge-red';
      document.getElementById('exLatency').textContent = (Date.now() - start) + 'ms';
      document.getElementById('exBody2').textContent = 'Network error: ' + e.message;
      resultEl.classList.remove('hidden');
    }
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showAlert(el, type, msg) {
    el.className = 'alert ' + (type === 'success' ? 'alert-success' : 'alert-error');
    el.textContent = msg;
    el.classList.remove('hidden');
  }

  function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function logout() {
    sessionStorage.clear();
    window.location.replace('/');
  }
  </script>
</body>
</html>
