# nginx-keycloak.conf
#
# Simple OIDC token proxy for Keycloak + DeltaDatabase.
#
# This configuration forwards requests to the DeltaDatabase Main Worker,
# replacing the caller's Keycloak JWT with the configured DeltaDatabase
# admin key.  Adapt the auth_request block to validate the JWT and map
# Keycloak roles to DeltaDatabase permissions as required.
#
# In production, replace the static admin-key forwarding with a proper
# auth_request sub-request that calls Keycloak's token introspection endpoint
# and maps roles to specific DeltaDatabase API keys.

server {
    listen 80;

    # ── Health check (no auth) ─────────────────────────────────────────────────
    location /health {
        proxy_pass         http://main-worker:8080;
        proxy_set_header   Host $host;
    }

    # ── Static frontend assets (no auth) ──────────────────────────────────────
    location / {
        # Serve the DeltaDatabase management UI; the browser authenticates
        # via Keycloak OIDC and then calls /api/login with the resulting token.
        proxy_pass         http://main-worker:8080;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
    }

    # ── API endpoints — forward with admin key header ──────────────────────────
    # In a production setup you would validate the Keycloak Bearer JWT here
    # using auth_request and only forward validated requests.
    location /entity/ {
        proxy_pass                    http://main-worker:8080;
        proxy_set_header              Host $host;
        proxy_set_header              Authorization "Bearer ${ADMIN_KEY}";
        proxy_set_header              X-Forwarded-For $remote_addr;
    }

    location /schema/ {
        proxy_pass                    http://main-worker:8080;
        proxy_set_header              Host $host;
        proxy_set_header              Authorization "Bearer ${ADMIN_KEY}";
    }

    location /admin/ {
        proxy_pass                    http://main-worker:8080;
        proxy_set_header              Host $host;
        proxy_set_header              Authorization "Bearer ${ADMIN_KEY}";
    }

    location /api/ {
        proxy_pass                    http://main-worker:8080;
        proxy_set_header              Host $host;
    }
}
